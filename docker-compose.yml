# Networks
networks:
  whisper-network:
    driver: bridge

# Volumes for data persistence
volumes:
  go-mod-cache:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0-jammy
    container_name: whisper-mongodb
    restart: unless-stopped
    
    # Security & Authentication
    environment:
      MONGO_INITDB_ROOT_USERNAME: whisper_admin
      MONGO_INITDB_ROOT_PASSWORD: whisper_secure_password_2024
      MONGO_INITDB_DATABASE: whisper_db
    
    # Port mapping
    ports:
      - "27017:27017"
    
    # Volume mounting for data persistence
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    
    # Health check
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Network
    networks:
      - whisper-network
    
    # Labels for monitoring
    labels:
      - "traefik.enable=false"
      - "service.name=whisper-mongodb"

  # Whisper API Server
  api:
    build:
      context: ./server
      target: dev
    
    # Dependency management
    depends_on:
      mongodb:
        condition: service_healthy
    
    # Environment configuration
    env_file:
      - ./server/.env
    
    container_name: api
    working_dir: /app
    volumes:
      - ./server:/app
      - go-mod-cache:/go/pkg/mod
    environment:
      - GIN_MODE=debug
      - APP_PORT=8080
    
    # Port mapping
    ports:
      - "8080:8080"
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    # Network
    networks:
      - whisper-network
    
    # Labels
    labels:
      - "service.name=whisper-api"
      - "service.version=1.0.0"

  # MongoDB Admin Interface (development)
  mongo-express:
    image: mongo-express:1.0.0-alpha
    container_name: whisper-mongo-express
    restart: unless-stopped
    
    # Dependency
    depends_on:
      mongodb:
        condition: service_healthy
    
    # Environment
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: whisper_admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: whisper_secure_password_2024
      ME_CONFIG_MONGODB_URL: mongodb://whisper_admin:whisper_secure_password_2024@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin123
    
    # Port
    ports:
      - "8081:8081"
    
    # Network
    networks:
      - whisper-network
    
    # Profile (development only)
    profiles:
      - "dev"
      - "development"
    
    # Labels
    labels:
      - "service.name=whisper-mongo-express" 
  web:
    build:
      context: ./client
      target: dev
    container_name: web
    working_dir: /app
    volumes:
      - ./client:/app
      - /app/node_modules
    environment:
      - REACT_APP_API_URL=http://api:8080/api/v1
      - CHOKIDAR_USEPOLLING=true
    ports:
      - "3000:3000"
    depends_on:
      - api
